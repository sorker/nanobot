# WebSocket å®æ—¶äº‹ä»¶æµ - æ›´æ–°æ—¥å¿—

## ç‰ˆæœ¬ï¼šå®æ—¶äº‹ä»¶æµæ”¯æŒ

**æ—¥æœŸ**ï¼š2026-02-05

### é—®é¢˜æè¿°

ä¹‹å‰çš„å®ç°ä¸­ï¼Œåå°åœ¨å¤„ç†æ¶ˆæ¯æ—¶ä¼šæ‰§è¡Œå¤šæ¬¡å·¥å…·è°ƒç”¨ï¼ˆä»æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼‰ï¼Œä½†å‰ç«¯åªèƒ½åœ¨æ‰€æœ‰å¤„ç†å®Œæˆåæ‰æ”¶åˆ°æœ€ç»ˆå“åº”ã€‚è¿™å¯¼è‡´ï¼š

1. ç”¨æˆ·çœ‹ä¸åˆ°ä¸­é—´æ‰§è¡Œè¿‡ç¨‹
2. é•¿æ—¶é—´ç­‰å¾…æ—¶ä¸çŸ¥é“ç³»ç»Ÿæ˜¯å¦åœ¨å·¥ä½œ
3. æ— æ³•è¿½è¸ªä»»åŠ¡è¿›åº¦
4. ç”¨æˆ·ä½“éªŒå·®

### æ ¹æœ¬åŸå› 

1. **`nanobot/agent/loop.py`**ï¼šåœ¨å·¥å…·æ‰§è¡Œå¾ªç¯ä¸­ï¼Œåªè®°å½•æ—¥å¿—ï¼Œä¸å‘é€ä¸­é—´äº‹ä»¶åˆ°æ¶ˆæ¯æ€»çº¿
2. **`nanobot/channels/websocket.py`**ï¼šåªæ”¯æŒå‘é€ `type: "message"` çš„æœ€ç»ˆå“åº”ï¼Œä¸æ”¯æŒå…¶ä»–äº‹ä»¶ç±»å‹

### è§£å†³æ–¹æ¡ˆ

#### 1. ä¿®æ”¹ WebSocket Channel

**æ–‡ä»¶**ï¼š`nanobot/channels/websocket.py`

**æ”¹åŠ¨**ï¼š
- ä¿®æ”¹ `send()` æ–¹æ³•ï¼Œæ”¯æŒä» `OutboundMessage.metadata["type"]` è¯»å–æ¶ˆæ¯ç±»å‹
- æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼š`message`ã€`tool`ã€`event`ã€`thinking`
- å¯¹äº `tool` ç±»å‹ï¼Œæ·»åŠ å·¥å…·åç§°å’Œå‚æ•°ä¿¡æ¯

```python
# ä¿®æ”¹å‰
response = {
    "type": "message",  # å›ºå®šç±»å‹
    "content": msg.content,
    ...
}

# ä¿®æ”¹å
msg_type = msg.metadata.get("type", "message") if msg.metadata else "message"
response = {
    "type": msg_type,  # åŠ¨æ€ç±»å‹
    "content": msg.content,
    ...
}
if msg_type == "tool":
    response["tool"] = msg.metadata.get("tool_name")
    response["arguments"] = msg.metadata.get("arguments")
```

#### 2. ä¿®æ”¹ Agent Loop

**æ–‡ä»¶**ï¼š`nanobot/agent/loop.py`

**æ”¹åŠ¨**ï¼š
- åœ¨ `_process_message()` å’Œ `_process_system_message()` çš„å·¥å…·æ‰§è¡Œå¾ªç¯ä¸­
- åœ¨æ‰§è¡Œæ¯ä¸ªå·¥å…·å‰ï¼Œå‘é€å·¥å…·æ‰§è¡Œäº‹ä»¶åˆ°æ¶ˆæ¯æ€»çº¿

```python
# ä¿®æ”¹å‰
for tool_call in response.tool_calls:
    logger.debug(f"Executing tool: {tool_call.name}...")
    result = await self.tools.execute(...)
    
# ä¿®æ”¹å
for tool_call in response.tool_calls:
    # å‘é€å·¥å…·æ‰§è¡Œäº‹ä»¶
    await self.bus.publish_outbound(OutboundMessage(
        channel=msg.channel,
        chat_id=msg.chat_id,
        content=f"æ­£åœ¨æ‰§è¡Œå·¥å…·: {tool_call.name}",
        metadata={
            "type": "tool",
            "tool_name": tool_call.name,
            "arguments": tool_call.arguments
        }
    ))
    
    # æ‰§è¡Œå·¥å…·
    result = await self.tools.execute(...)
```

### å‰ç«¯æ”¯æŒ

**æ–‡ä»¶**ï¼š`examples/websocket-ui/public/app.js`

å‰ç«¯å·²ç»æ”¯æŒè¿™äº›äº‹ä»¶ç±»å‹ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š
- ç¬¬163-173è¡Œï¼šæ¶ˆæ¯ç±»å‹åˆ†å‘
- ç¬¬290-306è¡Œï¼šå¤„ç† `thinking`ã€`event`ã€`tool` ç±»å‹çš„æ¶ˆæ¯
- ç¬¬345-410è¡Œï¼šUI æ¸²æŸ“é€»è¾‘

### æ¶ˆæ¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket Channel  â”‚
â”‚  (receive message)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Message Bus       â”‚
â”‚   (inbound queue)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent Loop        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â†’ ğŸ”§ Tool Event â”€â”€â†’ Message Bus â”€â”€â†’ WebSocket â”€â”€â†’ å‰ç«¯æ˜¾ç¤º
       â”‚
       â”œâ”€â”€â†’ æ‰§è¡Œå·¥å…·
       â”‚
       â”œâ”€â”€â†’ ğŸ”§ Tool Event â”€â”€â†’ Message Bus â”€â”€â†’ WebSocket â”€â”€â†’ å‰ç«¯æ˜¾ç¤º
       â”‚
       â”œâ”€â”€â†’ æ‰§è¡Œå·¥å…·
       â”‚
       â””â”€â”€â†’ ğŸ“¨ Final Response â”€â”€â†’ Message Bus â”€â”€â†’ WebSocket â”€â”€â†’ å‰ç«¯æ˜¾ç¤º
```

### æ•ˆæœå¯¹æ¯”

#### ä¿®æ”¹å‰ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·: å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªhello worldçš„pdf         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚         [ç­‰å¾…30ç§’ï¼Œçœ‹ä¸åˆ°ä»»ä½•åé¦ˆ]          â”‚
â”‚                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bot: æˆ‘ä¸ºæ‚¨åˆ›å»ºäº†ä¸€ä¸ªPythonè„šæœ¬...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¿®æ”¹åï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·: å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªhello worldçš„pdf         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ æ­£åœ¨æ‰§è¡Œå·¥å…·: exec                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ æ­£åœ¨æ‰§è¡Œå·¥å…·: exec                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ æ­£åœ¨æ‰§è¡Œå·¥å…·: write_file                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ æ­£åœ¨æ‰§è¡Œå·¥å…·: exec                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ æ­£åœ¨æ‰§è¡Œå·¥å…·: exec                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ æ­£åœ¨æ‰§è¡Œå·¥å…·: write_file                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ æ­£åœ¨æ‰§è¡Œå·¥å…·: exec                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bot: æˆ‘ä¸ºæ‚¨åˆ›å»ºäº†ä¸€ä¸ªPythonè„šæœ¬...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

1. **nanobot/channels/websocket.py**
   - ä¿®æ”¹ `send()` æ–¹æ³•ï¼ˆ86-117è¡Œï¼‰
   - æ–°å¢ï¼šæ”¯æŒåŠ¨æ€æ¶ˆæ¯ç±»å‹
   - æ–°å¢ï¼šå·¥å…·äº‹ä»¶çš„é¢å¤–å­—æ®µ

2. **nanobot/agent/loop.py**
   - ä¿®æ”¹ `_process_message()` ä¸­çš„å·¥å…·æ‰§è¡Œå¾ªç¯ï¼ˆ199-207è¡Œï¼‰
   - ä¿®æ”¹ `_process_system_message()` ä¸­çš„å·¥å…·æ‰§è¡Œå¾ªç¯ï¼ˆ293-301è¡Œï¼‰
   - æ–°å¢ï¼šåœ¨å·¥å…·æ‰§è¡Œå‰å‘é€äº‹ä»¶

3. **docs/WEBSOCKET_EVENTS.md** ï¼ˆæ–°å¢ï¼‰
   - è¯¦ç»†çš„åŠŸèƒ½æ–‡æ¡£
   - ä½¿ç”¨æŒ‡å—
   - æ‰©å±•å»ºè®®

4. **examples/test_realtime_events.md** ï¼ˆæ–°å¢ï¼‰
   - æµ‹è¯•æ­¥éª¤
   - æµ‹è¯•ç”¨ä¾‹
   - æ•…éšœæ’æŸ¥æŒ‡å—

### å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**

- ä¸å½±å“ç°æœ‰çš„æ¶ˆæ¯å¤„ç†é€»è¾‘
- å¦‚æœ `metadata` ä¸­æ²¡æœ‰ `type` å­—æ®µï¼Œé»˜è®¤ä½¿ç”¨ `"message"`
- å‰ç«¯å¦‚æœä¸å¤„ç†æ–°äº‹ä»¶ç±»å‹ï¼Œåªä¼šçœ‹åˆ°æœ€ç»ˆå“åº”ï¼ˆä¸ä¹‹å‰è¡Œä¸ºä¸€è‡´ï¼‰
- ä¸éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“

### æ€§èƒ½å½±å“

- âœ… **æœ€å°æ€§èƒ½å½±å“**
  - äº‹ä»¶å‘é€æ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡å·¥å…·æ‰§è¡Œ
  - JSON åºåˆ—åŒ–å¼€é”€å¾ˆå°
  - WebSocket æœ¬èº«æ”¯æŒé«˜å¹¶å‘æ¶ˆæ¯

- **ç½‘ç»œæµé‡å¢åŠ **ï¼š
  - æ¯ä¸ªå·¥å…·è°ƒç”¨å¢åŠ çº¦ 150-200 bytes
  - å¯¹äºæ‰§è¡Œ 10 ä¸ªå·¥å…·çš„ä»»åŠ¡ï¼Œå¢åŠ çº¦ 1.5-2 KB
  - å¯ä»¥å¿½ç•¥ä¸è®¡

### æµ‹è¯•å»ºè®®

#### 1. åŠŸèƒ½æµ‹è¯•
```bash
# å¯åŠ¨æœåŠ¡
nanobot gateway

# æ‰“å¼€è°ƒè¯•ç•Œé¢
open examples/websocket-ui/public/debug-connection.html

# å‘é€æµ‹è¯•æ¶ˆæ¯
"å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªhello worldçš„pdf"
```

#### 2. éªŒè¯ç‚¹
- âœ… å‰ç«¯æ”¶åˆ°å¤šä¸ª `type: "tool"` æ¶ˆæ¯
- âœ… æ¯ä¸ªå·¥å…·æ¶ˆæ¯åŒ…å«å·¥å…·åç§°å’Œå‚æ•°
- âœ… æœ€åæ”¶åˆ° `type: "message"` çš„æœ€ç»ˆå“åº”
- âœ… æ¶ˆæ¯é¡ºåºæ­£ç¡®
- âœ… ä¸­æ–‡å­—ç¬¦æ˜¾ç¤ºæ­£å¸¸

#### 3. å›å½’æµ‹è¯•
- âœ… å…¶ä»– channelï¼ˆCLIã€Telegramï¼‰ä¸å—å½±å“
- âœ… å•å·¥å…·è°ƒç”¨æ­£å¸¸å·¥ä½œ
- âœ… æ— å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯æ­£å¸¸å·¥ä½œ
- âœ… é”™è¯¯å¤„ç†æ­£å¸¸

### å·²çŸ¥é™åˆ¶

1. **ä»…æ”¯æŒ WebSocket**ï¼šå…¶ä»– channel éœ€è¦å•ç‹¬å®ç°
2. **æ— å·¥å…·ç»“æœ**ï¼šç›®å‰åªå‘é€å·¥å…·æ‰§è¡Œäº‹ä»¶ï¼Œä¸å‘é€ç»“æœï¼ˆå¯ä»¥åç»­æ·»åŠ ï¼‰
3. **æ— è¿›åº¦ç™¾åˆ†æ¯”**ï¼šä¸æ˜¾ç¤º"ç¬¬ 3/10 æ­¥"è¿™æ ·çš„ä¿¡æ¯ï¼ˆå¯ä»¥åç»­æ·»åŠ ï¼‰

### æœªæ¥æ”¹è¿›

1. **æ·»åŠ å·¥å…·ç»“æœäº‹ä»¶**
```python
# åœ¨å·¥å…·æ‰§è¡Œå
await self.bus.publish_outbound(OutboundMessage(
    content=f"å·¥å…·æ‰§è¡Œå®Œæˆ: {result[:100]}",
    metadata={"type": "event", "event_type": "tool_result"}
))
```

2. **æ·»åŠ è¿›åº¦ä¿¡æ¯**
```python
metadata={
    "type": "tool",
    "tool_name": tool_call.name,
    "progress": {"current": iteration, "total": len(response.tool_calls)}
}
```

3. **æ”¯æŒæµå¼å“åº”**
```python
# é€å­—å‘é€ LLM ç”Ÿæˆçš„å†…å®¹
async for chunk in self.provider.stream_chat(...):
    await self.bus.publish_outbound(OutboundMessage(
        content=chunk,
        metadata={"type": "streaming", "partial": True}
    ))
```

4. **å…¶ä»– channel æ”¯æŒ**
   - Telegram: ä½¿ç”¨ edit_message æ›´æ–°è¿›åº¦
   - CLI: ä½¿ç”¨è¿›åº¦æ¡æ˜¾ç¤º
   - Discord: ä½¿ç”¨ embed æ˜¾ç¤ºæ­¥éª¤

### ç›¸å…³ Issue/PR

- é—®é¢˜ï¼šå‰ç«¯æ²¡æœ‰æ¥æ”¶åˆ°å·¥å…·æ‰§è¡Œçš„ä¸­é—´äº‹ä»¶
- æ ¹æœ¬åŸå› ï¼šagent loop ä¸å‘é€ä¸­é—´äº‹ä»¶
- è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ å®æ—¶äº‹ä»¶æµæ”¯æŒ

### å‚è€ƒæ–‡æ¡£

- [WebSocket äº‹ä»¶æµæ–‡æ¡£](docs/WEBSOCKET_EVENTS.md)
- [æµ‹è¯•æŒ‡å—](examples/test_realtime_events.md)
- [WebSocket ä½¿ç”¨æŒ‡å—](docs/WEBSOCKET.md)

### æ€»ç»“

é€šè¿‡æœ€å°çš„ä»£ç æ”¹åŠ¨ï¼ˆçº¦30è¡Œï¼‰ï¼Œå®ç°äº†å®Œæ•´çš„å®æ—¶äº‹ä»¶æµæ”¯æŒã€‚ç”¨æˆ·ç°åœ¨å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ° Agent çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¤§å¹…æå‡äº†ç”¨æˆ·ä½“éªŒã€‚åŒæ—¶ä¿æŒäº†å®Œå…¨çš„å‘åå…¼å®¹æ€§ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ã€‚
